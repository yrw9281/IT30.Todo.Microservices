# Day 17 - Todo Service 實作 Create List

## Todo Service 回顧

![https://ithelp.ithome.com.tw/upload/images/20240930/20168953GsKJeraLtp.png](https://ithelp.ithome.com.tw/upload/images/20240930/20168953GsKJeraLtp.png)

很多細節都與前幾篇在實作 Account Service 一致，這邊算是一個複習。我建議讀者可以試著自己寫看看。接下來我還是會照著 Coding 的順序來實作，但解釋會變少，有不理解的可以回去重溫 Account Service 的流程。

## todoList.proto 實作

開新的 protobuf 記得要加入專案內，並設定為 Server。

```xml
  <ItemGroup>
    <Protobuf Include="Protos\todoList.proto" GrpcServices="Server" />
  </ItemGroup>
```

todoList.proto：

```protobuf
syntax = "proto3";

option csharp_namespace = "Todo.Grpc";

service TodoListGrpcService {
  rpc CreateTodoList (CreateTodoListRequest) returns (TodoListResponse);
}

message CreateTodoListRequest {
  string UserId = 1;
  string Name = 2;
  string Description = 3;
}

message TodoListResponse {
  string Id = 1;
  string UserId = 2;
  string Name = 3;
  string Description = 4;
  string Status = 5;
}
```

## GrpcTodoListService 實作 CreateTodoList

Override gRPC 實作

```csharp
using Grpc.Core;
using Todo.Application;

namespace Todo.Grpc.Services;

public class GrpcTodoListService : TodoListGrpcService.TodoListGrpcServiceBase
{
    private readonly ITodoListService _todoListService;

    public GrpcTodoListService(ITodoListService todoListService)
    {
        this._todoListService = todoListService;
    }

    public override Task<TodoListResponse> CreateTodoList(CreateTodoListRequest request, ServerCallContext context)
    {
        var result = _todoListService.CreateTodoList(new Guid(request.UserId), request.Name, request.Description);

        TodoListResponse response = new();

        return Task.FromResult(response);
    }
}
```

## 實作 TodoListService

### ITodoListService

```csharp
namespace Todo.Application;

public interface ITodoListService
{
    TodoListResult CreateTodoList(Guid userId, string name, string description);
}
```

### TodoListResult

```csharp
using Todo.Domain.ValueObjects.Enums;

namespace Todo.Application;

public record TodoListResult(
    Guid Id,
    Guid UserId,
    string Name,
    string Description,
    TodoListStatus Status
);
```

### TodoListService

```csharp
using Todo.Domain.Aggregates;

namespace Todo.Application;

public class TodoListService : ITodoListService
{
    private readonly List<TodoList> _todoLists = new();
    
    public TodoListResult CreateTodoList(Guid userId, string name, string description)
    {
        var list = TodoList.Create(name, description, userId);

        _todoLists.Add(list);

        return new TodoListResult(list.Id.Value, list.UserId, list.Name, list.Description, list.Status);
    }
}
```

## GrpcTodoListService 補上 Response

```csharp
public override Task<TodoListResponse> CreateTodoList(CreateTodoListRequest request, ServerCallContext context)
{
    var result = _todoListService.CreateTodoList(new Guid(request.UserId), request.Name, request.Description);

    TodoListResponse response = new()
    {
        Id = result.Id.ToString(),
        UserId = result.UserId.ToString(),
        Name = result.Name,
        Description = result.Description,
        Status = result.Status.ToString()
    };

    return Task.FromResult(response);
}
```

## Register Service

```csharp
using Microsoft.Extensions.DependencyInjection;

namespace Todo.Application;

public static class TodoApplicationRegister
{
    public static IServiceCollection AddTodoApplication(this IServiceCollection services)
    {
        services.AddScoped<ITodoListService, TodoListService>();

        return services;
    }
}
```

## Program.cs

```csharp
using Todo.Grpc.Services;
using Todo.Application;

var builder = WebApplication.CreateBuilder(args);

// Add services to the container.
builder.Services.AddGrpc();
builder.Services.AddGrpcReflection();
builder.Services.AddTodoApplication();

var app = builder.Build();

// Configure the HTTP request pipeline.
app.MapGrpcService<GrpcTodoListService>();
app.MapGrpcReflectionService();

app.Run();
```

## Test

### dotnet run

![https://ithelp.ithome.com.tw/upload/images/20240930/20168953rdk74pY54W.png](https://ithelp.ithome.com.tw/upload/images/20240930/20168953rdk74pY54W.png)

### gRPC Clicker Add Schema

這邊記得把 Timeout 填長一點，避免之後得一直改。

![https://ithelp.ithome.com.tw/upload/images/20240930/20168953IIBdexWQ2p.png](https://ithelp.ithome.com.tw/upload/images/20240930/20168953IIBdexWQ2p.png)

我們就可以看到新增的 `CreateTodoList` 的 Endpoint。

![https://ithelp.ithome.com.tw/upload/images/20240930/201689532Su1fhj3BD.png](https://ithelp.ithome.com.tw/upload/images/20240930/201689532Su1fhj3BD.png)

### gRPC Clicker Test

測試一下，看來沒甚麼問題。

![https://ithelp.ithome.com.tw/upload/images/20240930/20168953qtmATa4wt7.png](https://ithelp.ithome.com.tw/upload/images/20240930/20168953qtmATa4wt7.png)

## 結語

直到開始時做 Events 之前，接下來的幾個章節都會避免重複講先前已講過的概念與細節，會直接呈現結果，讀者可以自行先實作 Todo Service 的各項功能。
