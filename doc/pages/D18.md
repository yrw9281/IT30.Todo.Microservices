# Day 18 - Todo Service 實作 Create Item

## Todo Service 回顧

今天來實作 TodoItem 的 Create 方法，跟先前的做法差不多，大家可以先自行練習後在閱讀。

![https://ithelp.ithome.com.tw/upload/images/20240930/20168953w81xZyae0I.png](https://ithelp.ithome.com.tw/upload/images/20240930/20168953w81xZyae0I.png)

## todoItem.proto 實作

開新的 protobuf 記得要加入專案內，並設定為 Server。

```xml
  <ItemGroup>
    <Protobuf Include="Protos\todoItem.proto" GrpcServices="Server" />    
    <Protobuf Include="Protos\todoList.proto" GrpcServices="Server" />
  </ItemGroup>
```

todoItem.proto：

```protobuf
syntax = "proto3";

option csharp_namespace = "Todo.Grpc";

service TodoItemGrpcService {
  rpc CreateTodoItem (CreateTodoItemRequest) returns (TodoItemResponse);
}

message CreateTodoItemRequest {
  string ListId = 1;
  string Content = 2;
}

message TodoItemResponse {
  string Id = 1;
  string ListId = 2;
  string Content = 3;
  string Status = 4;
  string Color = 5;
}
```

## GrpcTodoItemService 實作 CreateTodoItem

Override gRPC 實作

```csharp
using Grpc.Core;
using Todo.Application;

namespace Todo.Grpc.Services;

public class GrpcTodoItemService : TodoItemGrpcService.TodoItemGrpcServiceBase
{
    private readonly ITodoItemService _todoItemService;

    public GrpcTodoItemService(ITodoItemService todoItemService)
    {
        this._todoItemService = todoItemService;
    }

    public override Task<TodoItemResponse> CreateTodoItem(CreateTodoItemRequest request, ServerCallContext context)
    {
        var result = _todoItemService.CreateTodoItem(new Guid(request.ListId), request.Content);

        TodoItemResponse response = new();
    
        return Task.FromResult(response);
    }
}
```

## 實作 TodoItemService

### ITodoItemService

```csharp
namespace Todo.Application;

public interface ITodoItemService
{
    TodoItemResult CreateTodoItem(Guid listId, string content);
}
```

### TodoItemResult

```csharp
using Todo.Domain.ValueObjects;

namespace Todo.Application;

public record TodoItemResult(
    Guid Id,
    Guid ListId,
    string Content,
    TodoItemStatus Status
);
```

### TodoItemService

```csharp
using Todo.Domain.Aggregates;

namespace Todo.Application;

public class TodoItemService : ITodoItemService
{
    private readonly List<TodoItem> _todoItems = new();
    
    public TodoItemResult CreateTodoItem(Guid userId, string content)
    {
        var item = TodoItem.Create(content, userId);

        _todoItems.Add(item);

        return new TodoItemResult(item.Id.Value, item.ListId, item.Content, item.Status);
    }
}
```

## GrpcTodoItemService 補上 Response

```csharp
public override Task<TodoItemResponse> CreateTodoItem(CreateTodoItemRequest request, ServerCallContext context)
{
    var result = _todoItemService.CreateTodoItem(new Guid(request.ListId), request.Content);

    TodoItemResponse response = new()
    {
        Id = result.Id.ToString(),
        ListId = result.ListId.ToString(),
        Content = result.Content,
        Status = result.Status.State.ToString(),
        Color = result.Status.Color
    };

    return Task.FromResult(response);
}
```

## Register Service

```csharp
using Microsoft.Extensions.DependencyInjection;

namespace Todo.Application;

public static class TodoApplicationRegister
{
    public static IServiceCollection AddTodoApplication(this IServiceCollection services)
    {
        services.AddScoped<ITodoListService, TodoListService>();
        services.AddScoped<ITodoItemService, TodoItemService>();

        return services;
    }
}
```

## Program.cs

```csharp
app.MapGrpcService<GrpcTodoItemService>();
```

## Test

### gRPC Clicker Test

當 Map 一個新的 gRPC Service 後，Reflection 會讓 gRPC Clicker 知道有新的 Endpoint 和其 Payload。

![https://ithelp.ithome.com.tw/upload/images/20240930/201689530dVJkat4P7.png](https://ithelp.ithome.com.tw/upload/images/20240930/201689530dVJkat4P7.png)

測試一下，OK 沒有問題，有正確的 Status 和 Color。

![https://ithelp.ithome.com.tw/upload/images/20240930/20168953UxGuaqGEVd.png](https://ithelp.ithome.com.tw/upload/images/20240930/20168953UxGuaqGEVd.png)

## 結語

附上目前為止的專案架構圖

![https://ithelp.ithome.com.tw/upload/images/20240930/201689532mNR1PaZg7.png](https://ithelp.ithome.com.tw/upload/images/20240930/201689532mNR1PaZg7.png)
